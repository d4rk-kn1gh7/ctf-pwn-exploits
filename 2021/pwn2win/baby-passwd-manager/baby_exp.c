#define _GNU_SOURCE

#include <netdb.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/socket.h>
#include <time.h>
#include <assert.h>
#include <stdint.h>
#include <dlfcn.h>
#include <sys/mman.h>
#include <unistd.h>
#include <x86intrin.h>
#define SA struct sockaddr

__attribute__((naked))  void clflush(volatile void *p) {
    __asm__( ".intel_syntax noprefix;"
             "mfence;"
             "clflush [rdi];"
             "mfence;"
             "ret;"
             ".att_syntax;"
             );
}

unsigned long probe_timing(char *adrs) {
    volatile unsigned long time;
    asm volatile(
        "    mfence             \n"
        "    lfence             \n"
        "    rdtsc              \n"
        "    lfence             \n"
        "    movl %%eax, %%esi  \n"
        "    movl (%1), %%eax   \n"
        "    lfence             \n"
        "    rdtsc              \n"
        "    subl %%esi, %%eax  \n"
        "    clflush 0(%1)      \n"
        : "=a" (time)
        : "c" (adrs)
        : "%esi", "%edx"
    );
    return time;
}

void maccess(void* p)
{
  asm volatile ("movq (%0), %%rax\n"
    :
    : "c" (p)
    : "rax");
}

void flush(void* p) {
    asm volatile ("clflush 0(%0)\n"
      :
      : "c" (p)
      : "rax");
}

int pseudo_sleep(size_t iter){
    for (size_t i = 0; i < iter; i++);
    return 0;
}

int main(){
    
    unsigned long t1,t2;
    double total_access,total_evict;
    unsigned long count=0;

    int sockfd, connfd;
    struct sockaddr_in servaddr, cli;
    clock_t start, end;

    // socket create and varification
    sockfd = socket(AF_INET, SOCK_STREAM, 0);
    if (sockfd == -1) {
        printf("socket creation failed...\n");
        exit(0);
    }
    else
        printf("Socket successfully created..\n");
    bzero(&servaddr, sizeof(servaddr));
  
    // assign IP, PORT
    servaddr.sin_family = AF_INET;
    servaddr.sin_addr.s_addr = inet_addr("127.0.0.1");
    servaddr.sin_port = htons(8080);
  
    // connect the client socket to server socket
    if (connect(sockfd, (SA*)&servaddr, sizeof(servaddr)) != 0) {
        printf("connection with the server failed...\n");
        exit(0);
    }
    else
        printf("connected to the server..\n");

    int i=ITER1;
    int j=ITER2;
    int n = (i << 3) + j;
    unsigned char bytes[4];
    bytes[3] = (n >> 24) & 0xFF;
    bytes[2] = (n >> 16) & 0xFF;
    bytes[1] = (n >> 8) & 0xFF;
    bytes[0] = n & 0xFF;
    for(unsigned i=0;i<100;i++){
        clflush(&getenv);
        if (i%2==0){
            write(sockfd, bytes, sizeof(bytes));
            pseudo_sleep(10000);
        }
        t1=probe_timing((void *)&getenv);
        count++;
        if (i%2==0){
            total_access+=(double)t1;
        }
        else{
            total_evict+=(double)t1;
        }
    }
    printf("%lf",total_access/50);

    return 0;
}
