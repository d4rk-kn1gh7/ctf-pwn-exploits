#!/usr/bin/python

from pwn import *
import sys
import os

remote_ip = ['docker-sgp1.nc.jctf.pro', 'docker-ams3.nc.jctf.pro', 'docker-nyc3.nc.jctf.pro']
port = 1337 

context.terminal = ['tmux', 'splitw', '-h']
context.arch = "amd64"
context.log_level = "debug"

re = lambda a: io.recv(a)
reu = lambda a: io.recvuntil(a)
rl = lambda: io.recvline(False)
s = lambda a: io.send(a)
sl = lambda a: io.sendline(a)
sla = lambda a,b: io.sendlineafter(a,b)
sa = lambda a,b: io.sendafter(a,b)

io = remote(remote_ip[0], port)

if __name__ == "__main__":
    reu("Proof of Work:\r\n")
    data = os.popen(reu("\r").replace("\r","")).read()
    sla("Your PoW: ", data)
    ans1 = "Intel(R) Xeon(R) Gold 6140 CPU @ 2.30GHz"
    get2 = "cut -c9- < /proc/1/cpuset"
    socket = "socat - UNIX-CONNECT:/oracle.sock"
    ans3 = "for i in {1..10}; do sleep 10 ; cat secret ; done &"
    sl(get2)
    reu(":/$ "+ get2 + "\r\n")
    ans2 = rl()
    sl("mount")
    reu("lowerdir=")
    dirs = reu(",").replace(",","").split(":")
    reu("upperdir=")
    upperdir = reu("/diff")
    reu("workdir=")
    workdir = reu("/work").replace("/work", "")
    sl("ls sys/kernel/slab/:A-0000128/cgroup")
    sl(ans3)
    sl(socket)
    sla("model used?\r\n", ans1)
    sa("*container id*?\r\n", ans2)
    reu("hidden secret?\r\n")
    ans = re(0x40)
    sl(ans)
    ans4 = "{}/secret".format(upperdir)
    sla("one of them)\r\n", ans4)
    io.interactive()
