# Echoserver

This challenge is from BatPwnCTF 2020, based on format string + ROP

## Vulnerability

Format string bug, attempted `%n` filter fails due to it only checking for consecutive indices. The program also only reads 1024 bytes into the buffer, but we can control this if we manage to overwrite the variable `local_14`. It executes this loop as long as `local_1c` is equal to zero, which we can also overwrite. This program also does an optimized leave using the following instructions:

```asm
   0x08049fb3 <+256>:   pop    ecx
   0x08049fb4 <+257>:   pop    ebx
   0x08049fb5 <+258>:   pop    ebp
   0x08049fb6 <+259>:   lea    esp,[ecx-0x4]
   0x08049fb9 <+262>:   ret
```

Hence we just need to overwrite the location of `pop ecx` on the stack with the address of our ropchain + 0x4, then we can execute it. Also, the character `0x0a` kills printf, so the ropchain had to be formed with gadgets not containing that character.

```cpp
undefined4 main(void)
{
  int iVar1;
  char local_41c [1024];
  int local_1c;
  char *local_18;
  int local_14;
  undefined *local_10;
  
  local_10 = &stack0x00000004;
  local_18 = local_41c;
  local_1c = 0;
  local_14 = 0xd;
  setvbuf((FILE *)stdout,(char *)0x0,2,0);
  signal(0xe,tooslow);
  alarm(0x14);
  while (local_1c == 0) {
    iVar1 = 0x3ff;
    if (local_14 < 0x400) {
      iVar1 = local_14;
    }
    local_14 = iVar1;
    printf("Reading %d bytes\n",iVar1);
    read_until(local_41c,local_14,10);
    filter(local_41c);
    printf(local_41c);
    putchar(10);
    alarm(0x14);
  }
  return 0;
}
```

## Short Solution

Leak stack address using format string, write ropchain to stack, overwrite the location of `pop ecx` on the stack using format string to return to our ropchain, and overwrite checking variable using format string to exit the loop and execute our ropchain.